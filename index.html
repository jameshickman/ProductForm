<!DOCTYPE html>
<html>
    <head>
        <title>Product record</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <product-form>
            <form slot="primary">
                <div class="form__row">
                    <div class="form__container_half">
                        <label for="txt1">Product Name <span style="color: red;">*</span></label>
                        <input id="txt1" type="text" name="txt-input" identity data-required data-length="3"/>
                    </div>
                    <div class="form__container_half">
                        <label for="sel1">Category <span style="color: red;">*</span></label>
                        <filtered-select>
                            <select id="sel1" name="sel-input" data-required>
                                <option value="">Select...</option>
                                <option value="electronics">Electronics</option>
                                <option value="clothing">Clothing</option>
                                <option value="books">Books</option>
                                <option value="home">Home & Garden</option>
                                <option value="sports">Sports & Outdoors</option>
                                <option value="health">Health & Beauty</option>
                                <option value="automotive">Automotive</option>
                            </select>
                        </filtered-select>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__container_half">
                        <label for="price1">Price ($) <span style="color: red;">*</span></label>
                        <input id="price1" type="number" name="price" data-required/>
                    </div>
                    <div class="form__container_half">
                        <label for="sku1">SKU (Format: ABC-123)</label>
                        <input id="sku1" type="text" name="sku" data-regex="^[A-Z]{3}-[0-9]{3}$"/>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__container_half">
                        <label>Featured Product <span style="color: red;">*</span></label>
                        <trinary-input name="is_featured" data-required></trinary-input>
                    </div>
                    <div class="form__container_half">
                        <label>Available for Sale</label>
                        <trinary-input name="is_available"></trinary-input>
                    </div>
                </div>
            </form>
            <div slot="subforms">
                <form title="Product Details" style="display: none;" data-tags="description,condition,weight,brand,eco,edition">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="txt_1_1">Description (Min 10 chars)</label>
                            <input id="txt_1_1" type="text" name="description" data-length="10"/>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_1_1">Condition <span style="color: red;">*</span></label>
                            <filtered-select>
                                <select id="sel_1_1" name="condition" data-required>
                                    <option value="">Select...</option>
                                    <optgroup label="Brand New">
                                        <option value="new">New</option>
                                        <option value="new_open_box">New - Open Box</option>
                                        <option value="new_other">New - Other</option>
                                    </optgroup>
                                    <optgroup label="Pre-owned">
                                        <option value="used_excellent">Used - Excellent</option>
                                        <option value="used_good">Used - Good</option>
                                        <option value="used_fair">Used - Fair</option>
                                    </optgroup>
                                    <optgroup label="Renewed">
                                        <option value="refurbished">Refurbished</option>
                                        <option value="manufacturer_refurbished">Manufacturer Refurbished</option>
                                    </optgroup>
                                </select>
                            </filtered-select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="weight_1_1">Weight (kg)</label>
                            <input id="weight_1_1" type="number" step="0.01" name="weight"/>
                        </div>
                        <div class="form__container_half">
                            <label for="brand_1_1">Brand</label>
                            <filtered-select id="custom-theme-example">
                                <select id="brand_1_1" name="brand">
                                    <option value="">Select brand...</option>
                                    <optgroup label="Electronics">
                                        <option value="apple">Apple</option>
                                        <option value="samsung">Samsung</option>
                                        <option value="sony">Sony</option>
                                        <option value="lg">LG</option>
                                        <option value="panasonic">Panasonic</option>
                                    </optgroup>
                                    <optgroup label="Fashion">
                                        <option value="nike">Nike</option>
                                        <option value="adidas">Adidas</option>
                                        <option value="puma">Puma</option>
                                        <option value="gucci">Gucci</option>
                                        <option value="versace">Versace</option>
                                    </optgroup>
                                    <optgroup label="Home & Garden">
                                        <option value="ikea">IKEA</option>
                                        <option value="home_depot">Home Depot</option>
                                        <option value="lowes">Lowe's</option>
                                        <option value="wayfair">Wayfair</option>
                                    </optgroup>
                                </select>
                            </filtered-select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label>Eco-Friendly <span style="color: red;">*</span></label>
                            <trinary-input name="is_eco_friendly" data-required></trinary-input>
                        </div>
                        <div class="form__container_half">
                            <label>Limited Edition</label>
                            <trinary-input name="is_limited_edition"></trinary-input>
                        </div>
                    </div>
                </form>
                <form title="Inventory" style="display: none;" data-tags="stock,warehouse,reorder,supplier">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="txt_2_1">Stock Quantity <span style="color: red;">*</span></label>
                            <input id="txt_2_1" type="number" name="stock_quantity" data-required/>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_2_1">Warehouse <span style="color: red;">*</span></label>
                            <filtered-select theme="FilteredSelectDarkTheme">
                                <select id="sel_2_1" name="warehouse" data-required>
                                    <option value="">Select...</option>
                                    <option value="warehouse_a">Warehouse A - New York</option>
                                    <option value="warehouse_b">Warehouse B - California</option>
                                    <option value="warehouse_c">Warehouse C - Texas</option>
                                    <option value="warehouse_d">Warehouse D - Florida</option>
                                    <option value="warehouse_e">Warehouse E - Illinois</option>
                                </select>
                            </filtered-select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="reorder_2_1">Reorder Level</label>
                            <input id="reorder_2_1" type="number" name="reorder_level"/>
                        </div>
                        <div class="form__container_half">
                            <label for="supplier_2_1">Supplier</label>
                            <filtered-select>
                                <select id="supplier_2_1" name="supplier_code">
                                    <option value="">Select supplier...</option>
                                    <option value="SUP001">Acme Corp - Global Electronics</option>
                                    <option value="SUP002">TechSource Ltd - Computer Components</option>
                                    <option value="SUP003">Fashion Forward Inc - Clothing & Accessories</option>
                                    <option value="SUP004">Book Distributors LLC - Publishing</option>
                                    <option value="SUP005">Home Essentials Co - Furniture & Decor</option>
                                    <option value="SUP006">Sports Galaxy - Athletic Equipment</option>
                                    <option value="SUP007">Beauty Supply Chain - Cosmetics</option>
                                    <option value="SUP008">Auto Parts Direct - Automotive</option>
                                    <option value="SUP009">Green Living Supplies - Eco Products</option>
                                    <option value="SUP010">Quick Ship Express - Fast Delivery</option>
                                </select>
                            </filtered-select>
                        </div>
                    </div>
                </form>
                <form title="Shipping" style="display: none;" data-tags="shipping,fragile,dimensions,handling">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="shipping_class_3_1">Shipping Class</label>
                            <filtered-select placeholder="Search shipping classes...">
                                <select id="shipping_class_3_1" name="shipping_class">
                                    <option value="">Select shipping class...</option>
                                    <option value="standard">Standard Ground (5-7 days)</option>
                                    <option value="expedited">Expedited (3-4 days)</option>
                                    <option value="priority">Priority Express (1-2 days)</option>
                                    <option value="overnight">Overnight (Next day)</option>
                                    <option value="same_day">Same Day Delivery</option>
                                    <option value="freight">Freight/LTL (Large items)</option>
                                    <option value="international">International Standard</option>
                                    <option value="international_express">International Express</option>
                                </select>
                            </filtered-select>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_3_1">Fragile</label>
                            <filtered-select theme="FilteredSelectRoundedTheme">
                                <select id="sel_3_1" name="fragile">
                                    <option value="">Select...</option>
                                    <option value="no">No - Standard handling</option>
                                    <option value="fragile">Fragile - Handle with care</option>
                                    <option value="very_fragile">Very Fragile - Extra care required</option>
                                    <option value="hazardous">Hazardous - Special protocols</option>
                                </select>
                            </filtered-select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="dimensions_3_1">Dimensions (LxWxH cm)</label>
                            <input id="dimensions_3_1" type="text" name="dimensions" data-regex="^[0-9]+x[0-9]+x[0-9]+$"/>
                        </div>
                        <div class="form__container_half">
                            <label for="handling_3_1">Special Handling</label>
                            <input id="handling_3_1" type="text" name="special_handling"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="form__actions" slot="actions">
                <button name="save">Save Product</button>
                <button name="clear">Clear Forms</button>
                <button name="save_clear">Save and Clear</button>
            </div>
        </product-form>
    </body>
    <script type="module">
        import './js/lib/product-form.js';
        import './js/lib/trinary_ce.js';
    </script>
    <!-- Include filtered-select scripts -->
    <script src="js/lib/template.js"></script>
    <script src="js/lib/filtered-select-element.js"></script>
    <script type="module">
        
        window.addEventListener('load', () => {
            const productForm = document.querySelector('product-form');
            
            // Set up callbacks
            productForm.set_callbacks(
                // onSubmit callback
                (data) => {
                    console.log('Form submitted with data:', data);
                    const validationStatus = data.validation ? 'PASSED' : 'FAILED';
                     const version = data.version ? `Version: ${data.version}` : 'Version: NEW RECORD';
                    alert('Product saved!\nIdentity: ' + data.identity + '\n' + version + '\nValidation: ' + validationStatus + '\nData: ' + JSON.stringify(data.data, null, 2));
                },
                // onClear callback
                () => {
                    console.log('Form cleared');
                    alert('Form has been cleared');
                },
                // onDirty callback
                () => {
                    return confirm('You have unsaved changes. Are you sure you want to discard them?');
                }
            );
            
            // Simulate database backend operations
            async function simulateBackendLoad() {
                console.log('üì° Connecting to database...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('üîç Querying product record ID 234...');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('‚úÖ Record found! Loading data...');
                const databaseRecord = {
                    identity: 'b8c7e4a2-1f3d-4e5f-9a2b-6d8e1c3f7b9a4c2f8e1a3b5d7e9f2a4b6c8d0e1f3a5b7c9e0f2a4b6c8d0e1f3a5b7',
                    version: 234,
                    validation: true,
                    data: {
                        'txt-input': 'Wireless Bluetooth Headphones',
                        'sel-input': 'electronics',
                        'price': '79.99',
                        'sku': 'ELC-001',
                        'is_featured': 'true',
                        'is_available': 'true',
                        'description': 'Premium noise-canceling wireless headphones with 30-hour battery life',
                        'condition': 'new',
                        'weight': '0.25',
                        'brand': 'sony',
                        'is_eco_friendly': 'false',
                        'is_limited_edition': '',
                        'stock_quantity': '45',
                        'warehouse': 'warehouse_a',
                        'reorder_level': '10',
                        'supplier_code': 'SUP001',
                        'shipping_class': 'expedited',
                        'fragile': 'fragile',
                        'dimensions': '20x18x8',
                        'special_handling': 'Electronics - Handle with care'
                    }
                };
                
                productForm.value = databaseRecord;
                console.log('‚úÖ Database record loaded successfully');
                
                // Update all filtered-select displays after form data is loaded
                setTimeout(() => {
                    document.querySelectorAll('filtered-select').forEach(fs => {
                        if (fs.updateDisplayText) {
                            fs.updateDisplayText();
                        }
                    });
                }, 100);
            }
            
            // Enhanced save callback to simulate backend save
            const originalSubmitCallback = productForm.set_callbacks;
            productForm.set_callbacks(
                // onSubmit callback - simulate backend save
                async (data) => {
                    console.log('üíæ Saving to database...', data);
                    
                    try {
                        // Simulate network delay
                        await new Promise(resolve => setTimeout(resolve, 800));
                        
                        // Simulate assigning new version if it's a new record
                        if (!data.version) {
                            data.version = Math.floor(Math.random() * 1000) + 100;
                            console.log(`üÜï New record created with ID: ${data.version}`);
                        } else {
                            console.log(`‚úèÔ∏è Updated existing record ID: ${data.version}`);
                        }
                        
                        const validationStatus = data.validation ? 'PASSED' : 'FAILED';
                        const recordType = data.version < 234 ? 'NEW RECORD' : 'EXISTING RECORD';
                        const version = `Version: ${data.version}`;
                        
                        alert(`üíæ ${recordType} SAVED!\n\n` +
                              `Identity: ${data.identity}\n` +
                              `${version}\n` +
                              `Validation: ${validationStatus}\n\n` +
                              `Data: ${JSON.stringify(data.data, null, 2)}`);
                              
                    } catch (error) {
                        console.error('‚ùå Database save failed:', error);
                        alert('‚ùå Save failed! Please try again.');
                    }
                },
                // onClear callback
                () => {
                    console.log('üóëÔ∏è Form cleared - ready for new record');
                    alert('üóëÔ∏è Form has been cleared\nReady to create new record');
                },
                // onDirty callback
                () => {
                    return confirm('‚ö†Ô∏è Unsaved Changes\n\nYou have unsaved changes that will be lost.\nAre you sure you want to continue?');
                }
            );
            
            // Load database record after page loads
            setTimeout(() => {
                console.log('üöÄ Simulating database load...');
                simulateBackendLoad();
            }, 2000);
            
            // Set up custom theme for the example
            setTimeout(() => {
                const customThemeSelect = document.querySelector('#custom-theme-example');
                if (customThemeSelect && typeof createFilteredSelectTheme !== 'undefined') {
                    const customTheme = createFilteredSelectTheme({
                        backgroundColor: '#f0f8ff',
                        textColor: '#2c3e50',
                        borderColor: '#3498db',
                        hoverBorderColor: '#2980b9',
                        selectedBgColor: '#3498db',
                        selectedTextColor: 'white',
                        borderRadius: '8px',
                        fontSize: '14px',
                        dropdownShadow: '0 4px 12px rgba(52, 152, 219, 0.3)',
                        transitionSpeed: '0.2s'
                    });
                    customThemeSelect.setTheme(customTheme);
                }
            }, 500);
            
            // Simple positioning helper for dropdowns near viewport edges
            function setupDropdownPositioning() {
                const filteredSelects = document.querySelectorAll('filtered-select');
                
                filteredSelects.forEach(select => {
                    select.addEventListener('click', () => {
                        setTimeout(() => {
                            const dropdown = select.shadowRoot?.querySelector('.select-widget__dropdown-container');
                            if (dropdown && dropdown.style.display !== 'none') {
                                const selectRect = select.getBoundingClientRect();
                                const viewportHeight = window.innerHeight;
                                const spaceBelow = viewportHeight - selectRect.bottom;
                                
                                // If there's very little space below, try to show above
                                if (spaceBelow < 200 && selectRect.top > spaceBelow) {
                                    dropdown.style.top = 'auto';
                                    dropdown.style.bottom = '100%';
                                    dropdown.style.maxHeight = Math.min(250, selectRect.top - 10) + 'px';
                                } else {
                                    dropdown.style.top = '100%';
                                    dropdown.style.bottom = 'auto';
                                    dropdown.style.maxHeight = Math.min(250, spaceBelow - 10) + 'px';
                                }
                            }
                        }, 10);
                    });
                });
            }
            
            // Initialize positioning helper
            setTimeout(setupDropdownPositioning, 1000);
        });
    </script>
</html>