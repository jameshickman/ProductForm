<!DOCTYPE html>
<html>
    <head>
        <title>Product record</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <product-form>
            <form slot="primary">
                <div class="form__row">
                    <div class="form__container_half">
                        <label for="txt1">Product Name (Required)</label>
                        <input id="txt1" type="text" name="txt-input" identity data-required data-length="3"/>
                    </div>
                    <div class="form__container_half">
                        <label for="sel1">Category</label>
                        <select id="sel1" name="sel-input" data-required>
                            <option value="">Select...</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="books">Books</option>
                        </select>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__container_half">
                        <label for="price1">Price ($)</label>
                        <input id="price1" type="number" name="price" data-required/>
                    </div>
                    <div class="form__container_half">
                        <label for="sku1">SKU (Format: ABC-123)</label>
                        <input id="sku1" type="text" name="sku" data-regex="^[A-Z]{3}-[0-9]{3}$"/>
                    </div>
                </div>
                <div class="form__row">
                    <div class="form__container_half">
                        <label>Featured Product (Required)</label>
                        <trinary-input name="is_featured" data-required></trinary-input>
                    </div>
                    <div class="form__container_half">
                        <label>Available for Sale</label>
                        <trinary-input name="is_available"></trinary-input>
                    </div>
                </div>
            </form>
            <div slot="subforms">
                <form title="Product Details" style="display: none;">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="txt_1_1">Description (Min 10 chars)</label>
                            <input id="txt_1_1" type="text" name="description" data-length="10"/>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_1_1">Condition (Required)</label>
                            <select id="sel_1_1" name="condition" data-required>
                                <option value="">Select...</option>
                                <option value="new">New</option>
                                <option value="used">Used</option>
                                <option value="refurbished">Refurbished</option>
                            </select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="weight_1_1">Weight (kg)</label>
                            <input id="weight_1_1" type="number" step="0.01" name="weight"/>
                        </div>
                        <div class="form__container_half">
                            <label for="brand_1_1">Brand</label>
                            <input id="brand_1_1" type="text" name="brand"/>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label>Eco-Friendly (Required)</label>
                            <trinary-input name="is_eco_friendly" data-required></trinary-input>
                        </div>
                        <div class="form__container_half">
                            <label>Limited Edition</label>
                            <trinary-input name="is_limited_edition"></trinary-input>
                        </div>
                    </div>
                </form>
                <form title="Inventory" style="display: none;">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="txt_2_1">Stock Quantity (Required)</label>
                            <input id="txt_2_1" type="number" name="stock_quantity" data-required/>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_2_1">Warehouse (Required)</label>
                            <select id="sel_2_1" name="warehouse" data-required>
                                <option value="">Select...</option>
                                <option value="warehouse_a">Warehouse A</option>
                                <option value="warehouse_b">Warehouse B</option>
                                <option value="warehouse_c">Warehouse C</option>
                            </select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="reorder_2_1">Reorder Level</label>
                            <input id="reorder_2_1" type="number" name="reorder_level"/>
                        </div>
                        <div class="form__container_half">
                            <label for="supplier_2_1">Supplier Code</label>
                            <input id="supplier_2_1" type="text" name="supplier_code"/>
                        </div>
                    </div>
                </form>
                <form title="Shipping" style="display: none;">
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="txt_3_1">Shipping Class</label>
                            <input id="txt_3_1" type="text" name="shipping_class"/>
                        </div>
                        <div class="form__container_half">
                            <label for="sel_3_1">Fragile</label>
                            <select id="sel_3_1" name="fragile">
                                <option value="">Select...</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="form__row">
                        <div class="form__container_half">
                            <label for="dimensions_3_1">Dimensions (LxWxH cm)</label>
                            <input id="dimensions_3_1" type="text" name="dimensions" data-regex="^[0-9]+x[0-9]+x[0-9]+$"/>
                        </div>
                        <div class="form__container_half">
                            <label for="handling_3_1">Special Handling</label>
                            <input id="handling_3_1" type="text" name="special_handling"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="form__actions" slot="actions">
                <button name="save">Save Product</button>
                <button name="clear">Clear Forms</button>
                <button name="save_clear">Save and Clear</button>
            </div>
        </product-form>
    </body>
    <script type="module">
        import './js/lib/product-form.js';
        import './js/lib/trinary_ce.js';
        
        window.addEventListener('load', () => {
            const productForm = document.querySelector('product-form');
            
            // Set up callbacks
            productForm.set_callbacks(
                // onSubmit callback
                (data) => {
                    console.log('Form submitted with data:', data);
                    const validationStatus = data.validation ? 'PASSED' : 'FAILED';
                     const version = data.version ? `Version: ${data.version}` : 'Version: NEW RECORD';
                    alert('Product saved!\nIdentity: ' + data.identity + '\n' + version + '\nValidation: ' + validationStatus + '\nData: ' + JSON.stringify(data.data, null, 2));
                },
                // onClear callback
                () => {
                    console.log('Form cleared');
                    alert('Form has been cleared');
                },
                // onDirty callback
                () => {
                    return confirm('You have unsaved changes. Are you sure you want to discard them?');
                }
            );
            
            // Simulate database backend operations
            async function simulateBackendLoad() {
                console.log('üì° Connecting to database...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                console.log('üîç Querying product record ID 234...');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('‚úÖ Record found! Loading data...');
                const databaseRecord = {
                    identity: 'b8c7e4a2-1f3d-4e5f-9a2b-6d8e1c3f7b9a4c2f8e1a3b5d7e9f2a4b6c8d0e1f3a5b7c9e0f2a4b6c8d0e1f3a5b7',
                    version: 234,
                    validation: true,
                    data: {
                        'txt-input': 'Wireless Bluetooth Headphones',
                        'sel-input': 'electronics',
                        'price': '79.99',
                        'sku': 'ELC-001',
                        'is_featured': 'true',
                        'is_available': 'true',
                        'description': 'Premium noise-canceling wireless headphones with 30-hour battery life',
                        'condition': 'new',
                        'weight': '0.25',
                        'brand': 'TechAudio',
                        'is_eco_friendly': 'false',
                        'is_limited_edition': '',
                        'stock_quantity': '45',
                        'warehouse': 'warehouse_a',
                        'reorder_level': '10',
                        'supplier_code': 'SUP001',
                        'shipping_class': 'standard',
                        'fragile': 'yes',
                        'dimensions': '20x18x8',
                        'special_handling': 'Electronics - Handle with care'
                    }
                };
                
                productForm.value = databaseRecord;
                console.log('‚úÖ Database record loaded successfully');
            }
            
            // Enhanced save callback to simulate backend save
            const originalSubmitCallback = productForm.set_callbacks;
            productForm.set_callbacks(
                // onSubmit callback - simulate backend save
                async (data) => {
                    console.log('üíæ Saving to database...', data);
                    
                    try {
                        // Simulate network delay
                        await new Promise(resolve => setTimeout(resolve, 800));
                        
                        // Simulate assigning new version if it's a new record
                        if (!data.version) {
                            data.version = Math.floor(Math.random() * 1000) + 100;
                            console.log(`üÜï New record created with ID: ${data.version}`);
                        } else {
                            console.log(`‚úèÔ∏è Updated existing record ID: ${data.version}`);
                        }
                        
                        const validationStatus = data.validation ? 'PASSED' : 'FAILED';
                        const recordType = data.version < 234 ? 'NEW RECORD' : 'EXISTING RECORD';
                        const version = `Version: ${data.version}`;
                        
                        alert(`üíæ ${recordType} SAVED!\n\n` +
                              `Identity: ${data.identity}\n` +
                              `${version}\n` +
                              `Validation: ${validationStatus}\n\n` +
                              `Data: ${JSON.stringify(data.data, null, 2)}`);
                              
                    } catch (error) {
                        console.error('‚ùå Database save failed:', error);
                        alert('‚ùå Save failed! Please try again.');
                    }
                },
                // onClear callback
                () => {
                    console.log('üóëÔ∏è Form cleared - ready for new record');
                    alert('üóëÔ∏è Form has been cleared\nReady to create new record');
                },
                // onDirty callback
                () => {
                    return confirm('‚ö†Ô∏è Unsaved Changes\n\nYou have unsaved changes that will be lost.\nAre you sure you want to continue?');
                }
            );
            
            // Load database record after page loads
            setTimeout(() => {
                console.log('üöÄ Simulating database load...');
                simulateBackendLoad();
            }, 2000);
        });
    </script>
</html>